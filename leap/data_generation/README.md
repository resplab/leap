# Data Generation

In this module, we generate the datasets used for the `LEAP` model. This only needs to be
run once, and in general, users may ignore this folder. It is mainly for developers to reference
and update if new data needs to be added.

## Birth Data

To obtain the population data for each year, we used two tables from `StatCan`:

1. 1999 - 2021

For past years, we used 
[Table 17-10-00005-01 from StatCan](https://www150.statcan.gc.ca/t1/tbl1/en/cv.action?pid=1710000501).

The `*.csv` file can be downloaded from here:
[17100005-eng.zip](https://www150.statcan.gc.ca/n1/tbl/csv/17100005-eng.zip)

and is saved as:
`LEAP/leap/original_data/17100005.csv`

2. 2021 - 2065:

For future years, we used
[Table 17-10-0057-01 from StatCan](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1710005701).

The `*.csv` file can be downloaded from here:
[17100057-eng.zip](https://www150.statcan.gc.ca/n1/tbl/csv/17100057-eng.zip).

and is saved as:
`LEAP/leap/original_data/17100057.csv`


To run the data processing for the population data:

```sh
cd LEAP
python3 leap/data_generation/birth_data.py
```

This will update the following data files: 

1. `leap/processed_data/birth/birth_estimate.csv`
2. `leap/processed_data/birth/initial_pop_distribution_prop.csv`

## Death Data

To obtain the mortality data for each year, we used one table from `StatCan`:

1. 1996 - 2021

For past years, we used
[Table 13-10-00837-01 from StatCan](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310083701).

The `*.csv` file can be downloaded from here:
[13100837-eng.zip](https://www150.statcan.gc.ca/n1/tbl/csv/13100837-eng.zip).

and is saved as:
`LEAP/leap/original_data/13100837.csv`

2. 2021 - 2068

`StatCan` doesn't provide annual projections for death probabilities, but does provide a projection
for specific years (which we call calibration years) for the ``M3`` projection scenario only.
For Canada, this is 2068, and for BC, 2043.
The following equation can be used to obtain the probability of death in future years:

```math
\sigma^{-1}(p(sex, age, year)) = \sigma^{-1}(p(sex, age, year_0)) - e^{\beta(sex)(year - year_0) }
```

where $p(sex, age, year_0)$ is the probability of death for a person of that age/sex in the year
the collected data ends (in our case, 2020), and $p(sex, age, year)$ is the probability of death
for a person of that age/sex in a future year.

The parameter $\beta(sex)$ is unknown, and so we first need to calculate it.
To do so, we set $year = \text{calibration\\_year}$, and use the `Brent` root-finding algorithm to
optimize $\beta(sex)$ such that the life expectancy in the calibration year (which is known)
matches the predicted life expectancy.

Once we have found $\beta(sex)$, we can use this formula to find the projected death probabilities.

To run the data generation for the mortality data:

```sh
cd LEAP
python3 leap/data_generation/death_data.py
```

This will update the following data file: 

1. `leap/processed_data/life_table.csv`

## Migration Data

`StatCan` does not contain immigration/emigration data broken down by the necessary
groups (age, sex, etc), so we do not have exact data for this category. Instead, we use the
following data files:

1. `leap/processed_data/life_table.csv` (generated by `death_data.py`)
2. `leap/processed_data/birth/initial_pop_distribution_prop.csv` (generated by `birth_data.py`)

The `life_table.csv` contains the probability of death during that year for each age, sex, province,
and projection scenario.

The `initial_pop_distribution_prop.csv` contains the number of people in a given age, sex, province,
and projection scenario, along with the number of births for that year. This data is the net number
of people, factoring in death, immigration, and emigration.

To obtain the net migration, for anyone aged > 0, we compute the number of people in each age
group projected to die during that year based on the `prob_death` column in the `life_table.csv`.
Then we calculate the net change in people using the `n_age` column in the
`initial_pop_distribution_prop.csv`. We subtract the number of people who died from the net
population change to get the net number of people who migrated:

```python
delta_n = n - n_prev * (1 - prob_death)
```

**TODO**: The next part of the calculation is incorrect. `delta_N` is the change in population due
to migration. This model currently assumes that if `delta_N < 0`, 100% of migration is
emigration, and if `delta_N > 0`, 100% of migration is immigration. This has
led to the data being very inaccurate (for example, it appears as though people in their
90s are emigrating a lot and people in their 20s are not). This will be remedied in a
separate PR.


To run the data generation for the migration data:

```sh
cd LEAP
python3 leap/data_generation/migration_data.py
```

## Exacerbation Calibration Data

The number of exacerbations in a given year is modelled using a Poisson distribution. The formula is:

```math
\begin{align}
N_{\text{exacerbations}} &\sim \text{Poisson}(\lambda) = \dfrac{\lambda^k e^{-\lambda}}{k!}
\end{align}
```

Here $\lambda$ is the expected number of exacerbations per year. To obtain $\lambda$, we must perform a Poisson regression. The Poisson regression assumes that the value we are interested in can be approximated using the following formula:

```math
\begin{align}
\ln(\lambda) &= \ln(\alpha) + \beta_0 + \beta_{a} a + \beta_{s} s + \sum_{i=1}^3 \beta_i c_i 
\end{align}
```

where:

* **$\alpha$: calibration multiplier**
* $a$: age
* $\beta_a$: age constant
* $s$: sex
* $\beta_s$: sex constant
* $c_i$: relative time spent in control level $i$
* $\beta_i$: control level constant


In the `exacerbation_data.py` file, we are interested in calculating $\alpha$. If we rewrite the equation, the meaning of $\alpha$ becomes more apparent:

```math
\begin{align}
\lambda &= \alpha \cdot e^{\beta_0} e^{\beta_{a} a} e^{\beta_{s} s} \prod_{i=1}^3 e^{\beta_i c_i} 
\end{align}
```

How do we obtain $\alpha$? We again assume that the mean value has the same form as in a
Poisson regression, with the following formula:

```math
\begin{align}
\ln(\lambda_{C}) &= \sum_{i=1}^3 \gamma_i c_i 
\end{align}
```

* $\lambda_C$: the average number of exacerbations in a given year
* $c_i$: relative time spent in control level $i$
* $\gamma_i$: control level constant (different from $\beta_i$ above)

Here, the $\gamma_i$ values were calculated from the
[Economic Burden of Asthma (EBA) study](https://bmjopen.bmj.com/content/3/9/e003360.long)
and are given by:

```math
\begin{align}
\gamma_1 &:= 0.1880058 & \text{rate(exacerbation | fully controlled)}\\
\gamma_2 &:= 0.3760116 & \text{rate(exacerbation | partially controlled)}\\
\gamma_3 &:= 0.5640174 & \text{rate(exacerbation | uncontrolled)}
\end{align}
```

The number of exacerbations predicted by the model is then:

```math
\begin{align}
N_{\text{exac}}^{\text{(pred)}} &= \lambda_C \cdot N_{\text{asthma}}
\end{align}
```

* $N_{\text{asthma}}$: the number of people in a given year, age, sex with asthma

and number of hospitalizations is:

```math
\begin{align}
N_{\text{hosp}}^{\text{(pred)}} &= N_{\text{exac}}^{\text{(pred)}} \cdot P(\text{hosp})
\end{align}
```

* $N_{\text{exac}}^{\text{(pred)}}$: the predicted number of exacerbations (of any severity) for a given year, age, and sex
* $P(\text{hosp})$: the probability of hospitalization due to asthma given the patient has an asthma exacerbation

Finally, $\alpha$ can be computed:

```math
\begin{align}
\alpha(a, s, y) &= \dfrac{N_{\text{hosp}}(a, s, y)}{N_{\text{hosp}}^{\text{(pred)}}(a, s, y)}
\end{align}
```

To run the data generation for the exacerbation data:

```sh
cd LEAP
python3 leap/data_generation/exacerbation_data.py
```

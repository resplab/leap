# Data Generation

In this module, we generate the datasets used for the `LEAP` model. This only needs to be
run once, and in general, users may ignore this folder. It is mainly for developers to reference
and update if new data needs to be added.

## Birth Data

To obtain the population data for each year, we used two tables from `StatCan`:

1. 1999 - 2021

For past years, we used 
[Table 17-10-00005-01 from StatCan](https://www150.statcan.gc.ca/t1/tbl1/en/cv.action?pid=1710000501).

The `*.csv` file can be downloaded from here:
[17100005-eng.zip](https://www150.statcan.gc.ca/n1/tbl/csv/17100005-eng.zip)

and is saved as:
`LEAP/leap/original_data/17100005.csv`

2. 2021 - 2065:

For future years, we used
[Table 17-10-0057-01 from StatCan](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1710005701).

The `*.csv` file can be downloaded from here:
[17100057-eng.zip](https://www150.statcan.gc.ca/n1/tbl/csv/17100057-eng.zip).

and is saved as:
`LEAP/leap/original_data/17100057.csv`


To run the data processing for the population data:

```sh
cd LEAP
python3 leap/data_generation/birth_data.py
```

This will update the following data files: 

1. `leap/processed_data/birth/birth_estimate.csv`
2. `leap/processed_data/birth/initial_pop_distribution_prop.csv`

## Death Data

To obtain the mortality data for each year, we used one table from `StatCan`:

1. 1996 - 2021

For past years, we used
[Table 13-10-00837-01 from StatCan](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310083701).

The `*.csv` file can be downloaded from here:
[13100837-eng.zip](https://www150.statcan.gc.ca/n1/tbl/csv/13100837-eng.zip).

and is saved as:
`LEAP/leap/original_data/13100837.csv`

2. 2021 - 2068

`StatCan` doesn't provide annual projections for death probabilities, but does provide a projection
for specific years (which we call calibration years) for the ``M3`` projection scenario only.
For Canada, this is 2068, and for BC, 2043.
The following equation can be used to obtain the probability of death in future years:

```math
\sigma^{-1}(p(sex, age, year)) = \sigma^{-1}(p(sex, age, year_0)) - e^{\beta(sex)(year - year_0) }
```

where $p(sex, age, year_0)$ is the probability of death for a person of that age/sex in the year
the collected data ends (in our case, 2020), and $p(sex, age, year)$ is the probability of death
for a person of that age/sex in a future year.

The parameter $\beta(sex)$ is unknown, and so we first need to calculate it.
To do so, we set $year = \text{calibration\\_year}$, and use the `Brent` root-finding algorithm to
optimize $\beta(sex)$ such that the life expectancy in the calibration year (which is known)
matches the predicted life expectancy.

Once we have found $\beta(sex)$, we can use this formula to find the projected death probabilities.

To run the data generation for the mortality data:

```sh
cd LEAP
python3 leap/data_generation/death_data.py
```

This will update the following data file: 

1. `leap/processed_data/life_table.csv`

## Migration Data

`StatCan` does not contain immigration/emigration data broken down by the necessary
groups (age, sex, etc), so we do not have exact data for this category. Instead, we use the
following data files:

1. `leap/processed_data/life_table.csv` (generated by `death_data.py`)
2. `leap/processed_data/birth/initial_pop_distribution_prop.csv` (generated by `birth_data.py`)

The `life_table.csv` contains the probability of death during that year for each age, sex, province,
and projection scenario.

The `initial_pop_distribution_prop.csv` contains the number of people in a given age, sex, province,
and projection scenario, along with the number of births for that year. This data is the net number
of people, factoring in death, immigration, and emigration.

To obtain the net migration, for anyone aged > 0, we compute the number of people in each age
group projected to die during that year based on the `prob_death` column in the `life_table.csv`.
Then we calculate the net change in people using the `n_age` column in the
`initial_pop_distribution_prop.csv`. We subtract the number of people who died from the net
population change to get the net number of people who migrated:

```python
delta_n = n - n_prev * (1 - prob_death)
```

**TODO**: The next part of the calculation is incorrect. `delta_N` is the change in population due
to migration. This model currently assumes that if `delta_N < 0`, 100% of migration is
emigration, and if `delta_N > 0`, 100% of migration is immigration. This has
led to the data being very inaccurate (for example, it appears as though people in their
90s are emigrating a lot and people in their 20s are not). This will be remedied in a
separate PR.


To run the data generation for the migration data:

```sh
cd LEAP
python3 leap/data_generation/migration_data.py
```

## Exacerbation Calibration Data

The number of exacerbations in a given year is modelled using a Poisson distribution. The formula is:

```math
\begin{align}
N_{\text{exacerbations}} &\sim \text{Poisson}(\lambda) = \dfrac{\lambda^k e^{-\lambda}}{k!}
\end{align}
```

Here $\lambda$ is the expected number of exacerbations per year. To obtain $\lambda$, we must
perform a Poisson regression. The Poisson regression assumes that the value we are interested in
can be approximated using the following formula:

```math
\begin{align}
\ln(\lambda) &= \ln(\alpha) + \beta_0 + \beta_{a} a + \beta_{s} s + \sum_{i=1}^3 \beta_i c_i 
\end{align}
```

where:

* **$\alpha$: calibration multiplier**
* $a$: age
* $\beta_a$: age constant
* $s$: sex
* $\beta_s$: sex constant
* $c_i$: relative time spent in control level $i$
* $\beta_i$: control level constant


In the `exacerbation_data.py` file, we are interested in calculating $\alpha$. If we rewrite the
equation, the meaning of $\alpha$ becomes more apparent:

```math
\begin{align}
\lambda &= \alpha \cdot e^{\beta_0} e^{\beta_{a} a} e^{\beta_{s} s} \prod_{i=1}^3 e^{\beta_i c_i} 
\end{align}
```

How do we obtain $\alpha$? We again assume that the mean value has the same form as in a
Poisson regression, with the following formula:

```math
\begin{align}
\ln(\lambda_{C}) &= \sum_{i=1}^3 \gamma_i c_i 
\end{align}
```

* $\lambda_C$: the average number of exacerbations in a given year
* $c_i$: relative time spent in control level $i$
* $\gamma_i$: control level constant (different from $\beta_i$ above)

Here, the $\gamma_i$ values were calculated from the
[Economic Burden of Asthma (EBA) study](https://bmjopen.bmj.com/content/3/9/e003360.long)
and are given by:

```math
\begin{align}
\gamma_1 &:= 0.1880058 & \text{rate(exacerbation | fully controlled)}\\
\gamma_2 &:= 0.3760116 & \text{rate(exacerbation | partially controlled)}\\
\gamma_3 &:= 0.5640174 & \text{rate(exacerbation | uncontrolled)}
\end{align}
```

The number of exacerbations predicted by the model is then:

```math
\begin{align}
N_{\text{exac}}^{\text{(pred)}} &= \lambda_C \cdot N_{\text{asthma}}
\end{align}
```

* $N_{\text{asthma}}$: the number of people in a given year, age, sex with asthma

and number of hospitalizations is:

```math
\begin{align}
N_{\text{hosp}}^{\text{(pred)}} &= N_{\text{exac}}^{\text{(pred)}} \cdot P(\text{hosp})
\end{align}
```

* $N_{\text{exac}}^{\text{(pred)}}$: the predicted number of exacerbations (of any severity) for a
  given year, age, and sex
* $P(\text{hosp})$: the probability of hospitalization due to asthma given the patient has an
  asthma exacerbation

Finally, $\alpha$ can be computed:

```math
\begin{align}
\alpha(a, s, y) &= \dfrac{N_{\text{hosp}}(a, s, y)}{N_{\text{hosp}}^{\text{(pred)}}(a, s, y)}
\end{align}
```

To run the data generation for the exacerbation data:

```sh
cd LEAP
python3 leap/data_generation/exacerbation_data.py
```

## Asthma Incidence / Prevalence (Occurrence) Data

Initially there was a BC dataset and a Canadian dataset, but the incidence and prevalence rates
were very close, so we decided to just use the BC dataset and apply it to all provinces.

### British Columbia Ministry of Health Administrative Data

The asthma incidence and prevalence data was originally from a private database under the
BC Ministry of Health. This data had the following columns:

| Column | Type | Description |
| --- | --- | --- |
| `fiscal_year` | `str` | format "XXXX[A-z0-9]" |
| `age_group_desc` | `str` | format "X-Y years" or "<1 year" |
| `gender` | `str` | "M" or "F" |
| `incidence_numerator` | `float` | TODO |
| `prevalence_numerator` | `float` | TODO |
| `pop` | `int` | the number of people for a given age group, gender, and year |

TODO: prevalence / incidence calculation

This data was then processed and saved as `leap/original_data/private/asthma_inc_prev.csv`.

<div class="note" style='padding:15px; background-color:#E9D8FD; color:#69337A'>
<span>
<p style='text-align:left'>
<b>Note:</b></p>
<p>
This dataset is private, so please contact the developers regarding access.
</p>
</span>
</div>
</br>

The data is formatted as follows:

| Column | Type | Description |
| --- | --- | --- |
| `fiscal_year` | `int` | format `XXXX`, e.g `2000`, range `[2000, 2019]` |
| `age_group_desc` | `str` | format `"X-Y years"`, 5 year intervals |
| `gender` | `str` | `"M"` or `"F"` |
| `incidence` | `float` | the incidence of asthma in BC for a given year, age group, and sex, per 100 people |
| `prevalence` | `float` | the prevalence of asthma in BC for a given year, age group, and sex, per 100 people |

i.e.:

| fiscal_year | gender | age_group_desc | incidence | prevalence |
| --- | --- | --- | --- | --- |
| 2000 | F | 1-5 years | | |
| 2000 | F | 6-10 years | | |
| 2000 | F | 11-15 years | | |
| 2000 | F | 16-20 years | | |
| 2000 | F | 21-25 years | | |
| 2000 | F | 26-30 years | | |
| 2000 | F | 31-35 years | | |
| 2000 | F | 35-40 years | | |
| 2000 | F | 41-45 years | | |
| 2000 | F | 45-50 years | | |
| 2000 | F | 51-55 years | | |
| 2000 | F | 55-60 years | | |
| 2000 | F | 61-65 years | | |
| 2000 | M | 1-5 years | | |
| ... | ... | ... | | |
| 2019 | M | 61-65 years | | |

### Processing the Data

The BC Ministry of Health Administrative Dataset contains asthma incidence and prevalence data
for the years `2000-2019`, in 5-year age intervals. Since our model projects into the future, we
would like to be able to extend this data beyond `2019`. Our model also makes predictions at
1-year age intervals, not 5-year age intervals. To obtain these projections, we use a
`Generalized Linear Model (GLM)`. A `GLM` is a type of regression analysis which is a
generalized form of linear regression.
See the [GLM Documentation](https://resplab.github.io/leap/model/model-glm.html) for more
information on `GLMs`, and the
[Occurrence Model Documentation](https://resplab.github.io/leap/model/model-occurrence.html)
for more details on the `GLM` used for the occurrence data.


### Generating the Data

To run the data generation for the incidence/prevalence data:

```sh
cd LEAP
python3 leap/data_generation/occurrence_data.py
```

This will update the file `leap/processed_data/asthma_occurrence_predictions.csv`. This file
contains the predicted 
This will also create 4 figures:

1. `leap/data_generation/figures/asthma_incidence_comparison.png`
2. `leap/data_generation/figures/asthma_incidence_predicted.png`
3. `leap/data_generation/figures/asthma_prevalence_comparison.png`
4. `leap/data_generation/figures/asthma_prevalence_predicted.png`


## Asthma Control Coefficients

The purpose of the ``control_data.py`` file is to perform ordinal regression with random effects
on the EBA dataset. The coefficients generated by this regression will then by used by the
``control.py`` module to make predictions about asthma control during the simulation.

### EBA Data

The data comes from the ``Economic Burden of Asthma (EBA) Study``, which enrolled asthmatic
patients aged ``1-85`` from BC. Data was taken every 3 months for 1 year, for a total of
5 data points per patient.

This is a private dataset, saved as ``df_EBA.csv``. To access the dataset, please contact one of the
``LEAP`` developers.

<table class="table">
  <thead>
    <tr>
      <th>Column</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="notranslate">studyId</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      8-digit patient ID
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">visit</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      The visit number. Visits were scheduled every 3 months for a year. A value in
      <code class="notranslate">[1, 5]</code>.
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">daytimeSymptoms</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      1 = yes, 2 = no
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">nocturnalSymptoms</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      1 = yes, 2 = no
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">inhalerUse</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      1 = yes, 2 = no
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">limitedActivities</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      1 = yes, 2 = no
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">exacerbations</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      TODO
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">sex</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
          0 = female, 1 = male
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">age</code></td>
      <td>
      <code class="notranslate">float</code>
      </td>
      <td>
      Age in years
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">ageAtAsthmaDx</code></td>
      <td>
      <code class="notranslate">float</code>
      </td>
      <td>
      Age at asthma diagnosis
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">time_since_Dx</code></td>
      <td>
      <code class="notranslate">float</code>
      </td>
      <td>
      Time since asthma diagnosis in years
      </td>
    </tr>
    <tr>
      <td><code class="notranslate">time_since_Dx_cat</code></td>
      <td>
      <code class="notranslate">int</code>
      </td>
      <td>
      1 = TODO, 2 = TODO, 3 = TODO
      </td>
    </tr>
  </tbody>
</table>


### Running the Regression

To run the data generation for the asthma control data:

```sh
cd LEAP
python3 leap/data_generation/control_data.py
```